var Index=function(){const csrf_token=$('meta[name="csrf-token"]').attr("content");var tableItem,tableAttachment,aSelectedItem=[],getDetailAllowance=function(){$.ajax({type:"post",url:url+"app/flexy-allowance/allowance-request-detail-route.php",data:{nomer:noAllowance,_token:csrf_token,action:"get-detail-allowance"},dataType:"json",success:function(response){$("#request-id").html(response.nomer),$("#req-date").html(response.transaction_date),$("#req-name").html(response.user_name),$("#subject").val(response.subject),$("#cost-center").val(response.cost_center_name),$("#department").val(response.dept_name),$("#period").val(response.period),$(".allowance-number").val(response.allowance),$("#hr-status").val(response.hr_status),$("#hr-manager-status").val(response.hr_manager_status),"0"===response.hr_approve&&"0"===response.manager_approve?$("#btn-save-detail").removeAttr("disabled"):$("#btn-save-detail").attr("disabled","disabled")}})},handleItemData=function(){tableItem=$("#table-allowance-detail").DataTable({responsive:!0,autoWidth:!0,pageLength:15,searching:!0,paging:!0,lengthMenu:[[15,25,50],[15,25,50]],language:{info:"Show _START_ - _END_ from _TOTAL_ data",infoEmpty:"Show 0 - 0 from 0 data",infoFiltered:"",zeroRecords:"Data not found",loadingRecords:"Loading...",processing:"Processing..."},columnsDefs:[{searchable:!1,target:[0,1]},{orderable:!1,target:0}],processing:!0,serverSide:!0,ajax:{url:url+"app/flexy-allowance/allowance-request-detail-route.php",type:"POST",data:{nomer:noAllowance,_token:csrf_token,action:"list-item-detail-allowance"}},columns:[{data:"cbox",orderable:!1},{data:"rnum",orderable:!1},{data:"activity",orderable:!1},{data:"detail",orderable:!1},{data:"desc",orderable:!1},{data:"total_amount",orderable:!1},{data:"claim_amount",orderable:!1},{data:"date",orderable:!1},{data:"action",orderable:!1}],drawCallback:function(settings){$(".data-item-cbox").on("click",(function(){handleAddDeleteAselected($(this).val(),$(this).parents()[1])})),$("#btn-delete-item").attr("disabled",""),aSelectedItem.splice(0,aSelectedItem.length),handleTotal(settings.json.total_claim_amount)}})},handleTotal=function(total){const value_total=total;$("#total-claim-amount").val(value_total)},handleAddDeleteAselected=function(value,parentElement){var check_value=$.inArray(value,aSelectedItem);-1!==check_value?($(parentElement).removeClass("table-info"),aSelectedItem.splice(check_value,1)):($(parentElement).addClass("table-info"),aSelectedItem.push(value)),handleBtnDisableEnable()},handleBtnDisableEnable=function(){aSelectedItem.length>0?$("#btn-delete-item").removeAttr("disabled"):$("#btn-delete-item").attr("disabled","")},handleActivity=function(){$("#activity").select2({allowClear:!0,placeholder:"Select Activity",dataType:"json",ajax:{method:"POST",url:url+"app/flexy-allowance/allowance-request-detail-route.php",data:function(params){return{_token:csrf_token,action:"get-activity",search:params.term,page:params.page||1}},processResults:function(data,params){return params.page=params.page||1,{results:data.items,pagination:{more:!1}}}},templateResult:format,templateSelection:formatSelection}),getDetailActivity()},handleResetActivityDropdown=function(){$("#activity").on("select2:unselecting",(function(e){$("#detail-activity").empty(),$("#deskripsi").val(""),toastr.success("reset selection success"),$("#detail-activity").select2({placeholder:"Select Detail Activity"})}))};function format(repo){if(repo.loading)return repo.text;var $container=$("<div class='select2-result-repository clearfix'><div class='select2-result-repository__title'></div></div>");return $container.find(".select2-result-repository__title").text(repo.text),$container}function formatSelection(repo){return repo.text}var getDetailActivity=function(){$("#activity").change((function(e){e.preventDefault();const activityId=$(this).val();$.ajax({type:"post",url:url+"app/flexy-allowance/allowance-request-detail-route.php",data:{activity:activityId,_token:csrf_token,action:"get-activity-detail"},dataType:"json",success:function(response){const responseValue=response.item;arraysEqual(responseValue,$("#detail-activity").select2())||($("#detail-activity").empty(),$("#deskripsi").val(""),$("#detail-activity").select2({data:responseValue})),handleFillDescription()}})}))};function arraysEqual(arr1,arr2){if(arr1.length!==arr2.length)return!1;for(var i=0;i<arr1.length;i++)if(arr1[i].id!==arr2[i].id||arr1[i].text!==arr2[i].text)return!1;return!0}var handleFillDescription=function(){$("#detail-activity").change((function(e){e.preventDefault();const selectedText=$("#detail-activity").find(":selected").text();$("#deskripsi").val(selectedText)}))},handleClaimAmount=function(){var hasilLimit=$.ajax({type:"post",async:!1,url:url+"app/flexy-allowance/limit-statistik2.php",data:{_token:csrf_token},dataType:"json",success:function(response){var limitData;return{limit:response.limit,remain:response.remain}}});const userLimit=hasilLimit.responseJSON.limit,userRemainBalance=hasilLimit.responseJSON.remain;$("#jumlah-biaya-bon").on("keyup change",(function(){""===$(this).val()?$("#jumlah-biaya-klaim").prop("readonly",!0):$("#jumlah-biaya-klaim").prop("readonly",!1)})),$("#jumlah-biaya-klaim").on("keyup",(function(){const claimAmount=$("#jumlah-biaya-klaim").val(),totalAmount=parseInt($("#jumlah-biaya-bon").val()),intClaimAmount=parseInt(claimAmount),intUserRemain=parseInt(userRemainBalance),intUserLimit=parseInt(userLimit);intClaimAmount>totalAmount&&intClaimAmount>intUserRemain?($("#valid-invalid-biaya-klaim").html("insufficient balance & claim amount cannot exceed total amount!"),toastr.error("insufficient balance & claim amount cannot exceed total amount!"),$(".biaya-claim").addClass("is-invalid"),$("#btn-save-detail").attr("disabled","disabled")):intClaimAmount>intUserRemain?($("#valid-invalid-biaya-klaim").html("insufficient balance!"),toastr.error("insufficient balance!"),$(".biaya-claim").addClass("is-invalid"),$("#btn-save-detail").attr("disabled","disabled")):intClaimAmount>totalAmount?($("#valid-invalid-biaya-klaim").html("claim amount cannot exceed total amount!"),toastr.error("claim amount cannot exceed total amount!"),$(".biaya-claim").addClass("is-invalid"),$("#btn-save-detail").attr("disabled","disabled")):($(".biaya-claim").removeClass("is-invalid"),$("#btn-save-detail").removeAttr("disabled"))}))},handleSelect2=function(){$("#detail-activity").select2({placeholder:"Select/Type Detail Activity"})},handleSubmitDetailAllowance=function(){$("#btn-back").click((function(e){e.preventDefault(),window.location.href=url+"view/flexy-allowance/allowance-user-index.php"})),$("#form-allowance-detail").submit((function(e){e.preventDefault();const form=$(this);let formData=new FormData(form[0]);confirm("Is it correct?")&&$.ajax({type:"POST",url:url+"app/flexy-allowance/allowance-request-detail-route.php",data:formData,processData:!1,contentType:!1,success:function(response){toastr.success(response.data),setTimeout(()=>{location.reload()},3500)},error:function(response){$.each(response.responseJSON.data,(function(key,value){toastr.error(value)}))}})}))},handleSubmitForm=function(){$("#upload-attachment").submit((function(e){e.preventDefault();const form=$(this);let formData=new FormData(form[0]);$.ajax({type:"POST",url:url+"app/flexy-allowance/allowance-request-detail-route.php",data:formData,processData:!1,contentType:!1,Cache:!1,success:function(response){let obj;!0===response.success?($.each(response.data,(function(key,value){toastr.success(value)})),setTimeout(()=>{location.reload()},2e3)):$.each(response.data,(function(key,value){toastr.error(value)}))}})}))},handleItemAttachment=function(){var id_allowance=$("#allowance-numbe-doc").val();console.log(id_allowance),tableAttachment=$("#tableDocs").DataTable({responsive:!0,autoWidth:!0,pageLength:15,searching:!0,paging:!0,lengthMenu:[[15,25,50],[15,25,50]],language:{info:"Show _START_ - _END_ from _TOTAL_ data",infoEmpty:"Show 0 - 0 from 0 data",infoFiltered:"",zeroRecords:"Data not found",loadingRecords:"Loading...",processing:"Processing..."},columnsDefs:[{searchable:!1,target:[0,1]},{orderable:!1,target:0}],processing:!0,serverSide:!0,ajax:{url:url+"app/flexy-allowance/allowance-request-detail-route.php",type:"POST",data:{allowance:id_allowance,_token:csrf_token,action:"list-item-attachment"}},columns:[{data:"rnum",orderable:!1},{data:"name",orderable:!1},{data:"upload_time",orderable:!1},{data:"action",orderable:!1}],drawCallback:function(settings){$(".data-item-cbox").on("click",(function(){handleAddDeleteAselected($(this).val(),$(this).parents()[1])})),$("#btn-delete-item").attr("disabled",""),aSelectedItem.splice(0,aSelectedItem.length),handleTotal(settings.json.total_claim_amount)}})};return{init:function(){handleSelect2(),handleActivity(),handleResetActivityDropdown(),handleSelect2(),handleClaimAmount(),getDetailAllowance(),handleSubmitDetailAllowance(),handleItemData(),handleSubmitForm(),handleItemAttachment()}}}();$(document).ready((function(){Index.init()}));